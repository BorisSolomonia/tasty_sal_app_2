name: ğŸŒ Deploy Caddy Reverse Proxy

on:
  push:
    branches: [ master ]  # Updated to match project branch
    paths: [ "Caddyfile", "compose.yml", ".github/workflows/deploy-caddy.yml" ]
  workflow_dispatch:     # Allow manual deployment

env:
  VM_HOST: 34.141.45.73  # Updated VM host
  CADDY_PATH: "/opt/apps/nine-tones"  # Use same directory as main app

jobs:
  deploy-caddy:
    name: ğŸš€ Deploy Caddy to VM
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¤ Upload Caddy Configuration
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          source: "Caddyfile,compose.yml"
          target: ${{ env.CADDY_PATH }}
          overwrite: true

      - name: ğŸ”§ Setup Caddy Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ğŸ”§ Setting up Caddy environment..."
            
            # Create necessary directories
            sudo mkdir -p ${{ env.CADDY_PATH }}
            sudo mkdir -p /var/log/caddy
            sudo chown -R $USER:$USER ${{ env.CADDY_PATH }}
            
            # Create Docker networks
            echo "ğŸŒ Creating Docker networks..."
            sudo docker network create web 2>/dev/null || echo "Network 'web' already exists"
            
            # Create required volumes
            echo "ğŸ’¾ Creating Docker volumes..."
            sudo docker volume create caddy_data 2>/dev/null || echo "Volume 'caddy_data' already exists"
            
            echo "âœ… Environment setup completed"

      - name: ğŸš€ Deploy Caddy Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ğŸš€ Deploying Caddy reverse proxy..."
            
            cd ${{ env.CADDY_PATH }}
            
            # Stop existing Caddy if running
            echo "ğŸ›‘ Stopping existing Caddy container..."
            sudo docker compose down 2>/dev/null || echo "No existing Caddy container"
            
            # Check if main app is already deployed
            if docker ps --format '{{.Names}}' | grep -q '^nine-tones-app$'; then
              echo "âœ… Nine Tones App is already running, will add Caddy to existing setup"
              
              # Create full stack compose file with both services
              cat > docker-compose.yml << 'COMPOSE_EOF'
version: "3.9"
services:
  nine-tones-app:
    image: europe-west3-docker.pkg.dev/nine-tones-bots-2025-468320/apps/nine-tones-app:latest
    container_name: nine-tones-app
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "3000:3000"
      - "3001:3001"
    networks: [web]
    mem_limit: 1g
    cpus: "0.5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    networks: [web]
    environment:
      - CADDY_INGRESS_NETWORKS=web
    mem_limit: 128m
    cpus: "0.25"
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      nine-tones-app:
        condition: service_healthy

volumes:
  caddy_data:
    external: true
  caddy_config:
  caddy_logs:

networks:
  web:
    external: true
COMPOSE_EOF
              
              # Deploy full stack
              echo "ğŸŒŸ Deploying full stack (Nine Tones App + Caddy)..."
              sudo docker compose up -d
            else
              echo "âš ï¸ Nine Tones App not found. Please deploy the main app first."
              echo "Run: GitHub Actions -> 'Build & Deploy to GCP VM'"
              exit 1
            fi
            
            # Wait for Caddy to start
            sleep 10
            
            echo "âœ… Caddy deployment completed"

      - name: ğŸ”„ Reload Caddy Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ğŸ”„ Reloading Caddy configuration..."
            
            # Check if Caddy is running and reload config
            if sudo docker ps --format '{{.Names}}' | grep -q '^caddy$'; then
              echo "ğŸ”„ Reloading Caddy configuration..."
              sudo docker exec caddy caddy reload --config /etc/caddy/Caddyfile
              echo "âœ… Configuration reloaded successfully"
            else
              echo "âŒ Caddy container not running"
              exit 1
            fi

      - name: ğŸ” Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ğŸ” Performing Caddy health check..."
            
            # Wait for Caddy to be ready
            sleep 5
            
            # Check if Caddy container is running
            if ! sudo docker ps | grep -q caddy; then
              echo "âŒ Caddy container is not running"
              sudo docker logs caddy --tail 20
              exit 1
            fi
            
            # Test HTTP endpoint
            max_attempts=6
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Health check attempt $attempt/$max_attempts..."
              
              if curl -f --connect-timeout 10 --max-time 30 http://localhost/ >/dev/null 2>&1; then
                echo "âœ… Caddy health check passed!"
                break
              fi
              
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Caddy health check failed after $max_attempts attempts"
                echo "Container logs:"
                sudo docker logs caddy --tail 30
                exit 1
              fi
              
              sleep 10
              attempt=$((attempt + 1))
            done

      - name: ğŸ“Š Deployment Summary
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "ğŸ“Š Caddy Deployment Summary:"
            echo "=========================="
            echo "ğŸŒ Reverse Proxy: Caddy 2"
            echo "ğŸ  VM Host: ${{ env.VM_HOST }}"
            echo "ğŸ”— HTTP URL: http://${{ env.VM_HOST }}"
            echo "ğŸ¯ Target: Nine Tones App (nine-tones-app:3000/3001)"
            echo "ğŸ“… Deployed: $(date)"
            echo "ğŸ‘¤ By: ${{ github.actor }}"
            echo ""
            echo "ğŸ” Container Status:"
            sudo docker ps --filter name=caddy --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
            echo ""
            echo "ğŸ’¾ Resource Usage:"
            sudo docker stats --no-stream --format "table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}" caddy
